#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <string.h>
#include <sys/wait.h>
#define MAX_FILS 3

FILE *popen(const char *command, const char *mode);
int pclose(FILE *stream);

void executerCommande(char *commande){

    FILE *cmd;
    char result[1024];

    cmd = popen(commande, "r");
    if (cmd == NULL) {
        perror("popen");
        exit(EXIT_FAILURE);
    }
    while (fgets(result, sizeof(result), cmd)) {
        printf("%s", result);
    }
    pclose(cmd);
}

void avoirCommande(char *mot,char *fichier){
    char *commande = (char *) malloc(100);
    strcat(commande,"grep ");
    strcat(commande,mot);
    strcat(commande," ");
    strcat(commande,fichier);
    printf("Commande écrite : %s\n", commande);
    printf("Voici la liste des mots comprenants \" %s \" :\n", mot);
    executerCommande(commande);
    free(commande);
}



int main(int argc, char *argv[]){

    if (argc < 3){
        printf("Il manque des arguments (exo4 \"mot recherché\" [fichier1] [fichier2] ...\n");
        exit(0);
    }

    int n = argc-2;
    printf("debut, n=%d\n",n);

    printf("PID initial : %d\n", getpid());

    int i = 0;
    int proc_actif = n;

    while (proc_actif != 0){
        if(fork()==0){
            if (i>=MAX_FILS)
            {
                int *status;
                printf("ARRET\n");
                wait(status);
            } else{
                printf("go\n");
            }
            proc_actif--;
            printf("\n------  Je suis un processus nouveau %d, regarde moi  --------\n",i);
            printf("pid : %d et ppid :%d\n", getpid(),getppid());
            printf("Fichier sondé : %s\n", argv[i+2]);
            avoirCommande(argv[1],argv[i+2]);
            i++;
        } else {
            exit(0);
        }
    }
    printf("--> Fin process \n");


    return 0;
}