#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/wait.h>

int takeRessource(char* ressource){
	int fichier = open(ressource, O_RDWR);
	char valeur;
	int resultat = 0;

	lseek(fichier,0,SEEK_SET);
	lockf(fichier,F_LOCK,0);

	lseek(fichier,0,SEEK_SET);
	read(fichier,&valeur,1);

	printf("Lecture %s : %c\n", ressource, valeur);

	if(valeur-'0'>0){ 
		valeur --;
		printf("Ressource prise, il en reste donc %c\n", valeur);
		lseek(fichier,0,SEEK_SET);
		write(fichier, &valeur, 1);
		resultat = 1; //Ressource prise donc renvoie 1
	}

	lseek(fichier,0,SEEK_SET);
	lockf(fichier,F_ULOCK,0);

	close(fichier);
	return resultat;
}

void giveRessource(char* ressource){
	int fichier = open(ressource, O_RDWR);
	char valeur;

	lseek(fichier,0,SEEK_SET);
	lockf(fichier,F_LOCK,0);

	read(fichier,&valeur,1);

	valeur ++;
	printf("Ressource rendu, il en reste donc %c\n", valeur); 
	lseek(fichier,0,SEEK_SET);
	write(fichier, &valeur, 1);

	lseek(fichier,0,SEEK_SET);
	lockf(fichier,F_ULOCK,0);

	close(fichier);
}


int main(int argc, char* argv[]){
	int id = atoi(argv[1]);
	printf("Baigneur %d arrive à la piscine.\n", id);

	while(takeRessource("cabines.txt")==0 && takeRessource("paniers.txt")==0){
		printf("Baigneur %d attend pour les cabines ou paniers\n", id);
		sleep(1);
	}
	printf("Baigneur %d prend une cabine.\n", id);
	printf("Baigneur %d prend un panier.\n", id);

	printf("Baigneur %d se change\n", id);
	sleep(1);

	giveRessource("cabines.txt");
	printf("Baigneur %d libère la cabine\n", id);

	for(int i = rand()%10 ; i>=0 ; i--){
		printf("Baigneur %d se baigne\n", id);
		sleep(1);
	}

	while(takeRessource("cabines.txt")==0){
		printf("Baigneur %d attend pour les cabines\n", id);
		sleep(1);
	}
	printf("Baigneur %d prend une cabine.\n", id);

	printf("Baigneur %d se change\n", id);
	sleep(1);

	giveRessource("cabines.txt");
	giveRessource("paniers.txt");
	printf("Baigneur %d libère la cabine\n", id);
	printf("Baigneur %d libère le panier\n", id);

	printf("Baigneur %d s'en va de la piscine\n", id);




	return 1;
}