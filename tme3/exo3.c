#include<stdio.h>
#include<stdlib.h>
#include<sys/types.h>
#include<unistd.h>
#include<sys/wait.h>
#include<dirent.h>
#include<string.h>
#include<time.h>
#include<sys/stat.h>
#include<fcntl.h>

void lecture(int fic,int n){
	int lect = -1;

	for(int i=0;i<n;i++){
		read(fic,&lect,1);
		printf("%d a lu %c\n",getpid(), lect);
	}

	printf("Le fils %d se termine\n", getpid());

	exit(0);
}

int main(int argc, char* argv[]){

	if(argc < 2){
		printf("Pas assez d'arguments\n");
		exit(EXIT_FAILURE);
	}

	int lect;
	int fic;

	fic = open(argv[1],O_RDONLY);

	printf("Le pere %d commence\n", getpid());

	if(fork()==0){
		printf("Le premier fils %d commence\n",getpid());
		lecture(fic, 3);
	}

	wait(NULL);

	if(fork()!=0){
		read(fic,&lect,1);
		printf("%d a lu %c\n", getpid(), lect);
	}else{
		printf("Le second fils %d commence\n", getpid());
		lecture(fic, 3);
	}

	wait(NULL);

	close(fic);


	int fic2;

	fic2 = open(argv[1],O_RDONLY);

	if(fork()==0){
		printf("Le troisieme fils %d commence \n", getpid());
		lecture(fic2, 4);
	}

	wait(NULL);

	printf("le pere %d se termine\n", getpid());

	close(fic2);
}